{% extends 'base.html' %}

{% block content %}
<div style="max-width: 800px; margin: 3rem auto; background: white; padding: 2.5rem; border-radius: 1rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);">

    <!-- Header -->
    <div style="text-align: center; margin-bottom: 3rem;">
        <h2 style="color: #1e3a8a; font-weight: 800; font-size: 2rem; margin-bottom: 0.5rem;">Edit Listing</h2>
        <p style="color: #64748b;">Update your listing details and images.</p>
    </div>

    <!-- Display messages -->
    {% if messages %}
        {% for message in messages %}
        <div style="background-color: {% if message.tags == 'error' %}#fee2e2{% else %}#d1fae5{% endif %}; border: 1px solid {% if message.tags == 'error' %}#fca5a5{% else %}#6ee7b7{% endif %}; border-radius: 0.5rem; padding: 1rem; margin-bottom: 2rem;">
            <p style="color: {% if message.tags == 'error' %}#dc2626{% else %}#065f46{% endif %}; font-weight: 600; margin: 0;">{{ message }}</p>
        </div>
        {% endfor %}
    {% endif %}

    <!-- Display form errors at top -->
    {% if form.errors %}
    <div style="background-color: #fee2e2; border: 1px solid #fca5a5; border-radius: 0.5rem; padding: 1rem; margin-bottom: 2rem;">
        <p style="color: #dc2626; font-weight: 600; margin-bottom: 0.5rem;">Please correct the errors below:</p>
        <ul style="color: #dc2626; margin: 0; padding-left: 1.5rem;">
            {% for field, errors in form.errors.items %}
                {% for error in errors %}
                <li>{{ field|title }}: {{ error }}</li>
                {% endfor %}
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    <form method="post" enctype="multipart/form-data" id="listingForm" action="{% url 'edit_listing' listing.pk %}">
        {% csrf_token %}

        <!-- Basic Information -->
        <div style="margin-bottom: 2rem;">
            <h3 style="color: #1e3a8a; font-size: 1.25rem; font-weight: 700; margin-bottom: 1.5rem; border-bottom: 1px solid #e2e8f0; padding-bottom: 0.75rem;">
                Product Details</h3>

            <div style="margin-bottom: 1.5rem;">
                <label for="{{ form.title.id_for_label }}" style="display: block; margin-bottom: 0.5rem; color: #475569; font-weight: 500;">Listing Title</label>
                {{ form.title }}
                {% if form.title.errors %}
                <p style="font-size: 0.8rem; color: #ef4444; margin-top: 0.25rem;">{{ form.title.errors.0 }}</p>
                {% endif %}
            </div>

            <div style="margin-bottom: 1.5rem;">
                <label for="{{ form.category.id_for_label }}" style="display: block; margin-bottom: 0.5rem; color: #475569; font-weight: 500;">Category</label>
                {{ form.category }}
                {% if form.category.errors %}
                <p style="font-size: 0.8rem; color: #ef4444; margin-top: 0.25rem;">{{ form.category.errors.0 }}</p>
                {% endif %}
            </div>

            <div style="margin-bottom: 1.5rem;">
                <label for="{{ form.price.id_for_label }}" style="display: block; margin-bottom: 0.5rem; color: #475569; font-weight: 500;">Price (â‚¹)</label>
                {{ form.price }}
                {% if form.price.errors %}
                <p style="font-size: 0.8rem; color: #ef4444; margin-top: 0.25rem;">{{ form.price.errors.0 }}</p>
                {% endif %}
            </div>

            <div style="margin-bottom: 1.5rem;">
                <label for="{{ form.description.id_for_label }}" style="display: block; margin-bottom: 0.5rem; color: #475569; font-weight: 500;">Description</label>
                {{ form.description }}
                {% if form.description.errors %}
                <p style="font-size: 0.8rem; color: #ef4444; margin-top: 0.25rem;">{{ form.description.errors.0 }}</p>
                {% endif %}
            </div>
        </div>

        <!-- Existing Images -->
        {% if existing_images %}
        <div style="margin-bottom: 2rem;">
            <h3 style="color: #1e3a8a; font-size: 1.25rem; font-weight: 700; margin-bottom: 1.5rem; border-bottom: 1px solid #e2e8f0; padding-bottom: 0.75rem;">
                Current Images ({{ existing_images|length }}/5)</h3>
            
            <form method="post" id="deleteImageForm" style="margin-bottom: 1.5rem;">
                {% csrf_token %}
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem;">
                    {% for img in existing_images %}
                    <div style="position: relative; border: 2px solid #e5e7eb; border-radius: 0.5rem; overflow: hidden;">
                        <img src="{{ img.image.url }}" alt="Image {{ forloop.counter }}" 
                             style="width: 100%; height: 150px; object-fit: cover; display: block;">
                        <label style="position: absolute; top: 0.5rem; right: 0.5rem; background: rgba(239, 68, 68, 0.9); color: white; padding: 0.25rem 0.5rem; border-radius: 0.25rem; cursor: pointer; font-size: 0.75rem; font-weight: 600; display: flex; align-items: center; gap: 0.25rem;">
                            <input type="checkbox" name="delete_images" value="{{ img.id }}" style="margin-right: 0.25rem;" onchange="updateDeleteButton()">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                        </label>
                    </div>
                    {% endfor %}
                </div>
                <button type="submit" id="deleteImagesBtn" 
                        style="margin-top: 1rem; padding: 0.5rem 1rem; background-color: #ef4444; color: white; border: none; border-radius: 0.5rem; font-weight: 600; cursor: pointer; display: none;">
                    Delete Selected Images
                </button>
            </form>
        </div>
        {% endif %}

        <!-- Add New Images -->
        <div style="margin-bottom: 2rem;">
            <h3 style="color: #1e3a8a; font-size: 1.25rem; font-weight: 700; margin-bottom: 1.5rem; border-bottom: 1px solid #e2e8f0; padding-bottom: 0.75rem;">
                Add New Images</h3>

            <div style="border: 2px dashed #cbd5e1; border-radius: 0.75rem; padding: 2rem; text-align: center; background: #f8fafc; margin-bottom: 1.5rem;">
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#94a3b8" stroke-width="2" style="margin-bottom: 1rem;">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                    <circle cx="8.5" cy="8.5" r="1.5"></circle>
                    <polyline points="21 15 16 10 5 21"></polyline>
                </svg>
                <p style="color: #64748b; margin-bottom: 1rem;">Click to select new images to add.</p>
                <input type="file" name="images" id="id_images" class="form-control" multiple accept="image/jpeg,image/png,image/jpg" style="display: none;" onchange="updateImagePreview(this)">
                <button type="button" onclick="document.getElementById('id_images').click()"
                    style="background: white; border: 1px solid #cbd5e1; color: #475569; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 500; cursor: pointer;">
                    Choose Files
                </button>
                <p style="font-size: 0.8rem; color: #94a3b8; margin-top: 0.5rem;">
                    Max <span id="maxNewImages">0</span> more images. JPG, PNG supported. Max 5MB per image.
                </p>
            </div>

            <div id="imagePreviewContainer" style="display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 1.5rem;"></div>
        </div>

        <!-- Action Buttons -->
        <div style="display: flex; justify-content: space-between; gap: 1rem; margin-top: 2rem; padding-top: 2rem; border-top: 1px solid #e2e8f0;">
            <a href="{% url 'my_listings' %}" 
               style="padding: 0.75rem 2rem; background: white; border: 1px solid #cbd5e1; color: #475569; border-radius: 0.5rem; text-decoration: none; font-weight: 600; text-align: center;">
                Cancel
            </a>
            <button type="submit" 
                    style="padding: 0.75rem 2rem; background-color: #16a34a; color: white; border: none; border-radius: 0.5rem; font-weight: 600; cursor: pointer; box-shadow: 0 4px 6px -1px rgba(22, 163, 74, 0.2);">
                Save Changes
            </button>
        </div>
    </form>
</div>

<script>
    // Calculate max new images on page load
    document.addEventListener('DOMContentLoaded', function() {
        const existingCount = {{ existing_images|length }};
        const maxNew = Math.max(0, 5 - existingCount);
        document.getElementById('maxNewImages').textContent = maxNew;
    });
    
    function updateImagePreview(input) {
        const container = document.getElementById('imagePreviewContainer');
        container.innerHTML = '';
        
        const existingCount = {{ existing_images|length }};
        const maxNew = Math.max(0, 5 - existingCount);
        
        if (input.files && input.files.length > maxNew) {
            alert(`You can only add ${maxNew} more images. You currently have ${existingCount} images.`);
            input.value = '';
            return;
        }

        if (input.files) {
            Array.from(input.files).forEach((file, index) => {
                // Validate file type
                if (!file.type.match('image/(jpeg|jpg|png)')) {
                    alert(`File ${file.name} is not a valid image type. Only JPEG and PNG are allowed.`);
                    return;
                }
                
                // Validate file size (5MB)
                if (file.size > 5 * 1024 * 1024) {
                    alert(`File ${file.name} is too large. Maximum size is 5MB.`);
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function (e) {
                    const div = document.createElement('div');
                    div.style.width = '120px';
                    div.style.height = '120px';
                    div.style.borderRadius = '0.5rem';
                    div.style.overflow = 'hidden';
                    div.style.border = '2px solid #3b82f6';
                    div.style.position = 'relative';

                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.style.width = '100%';
                    img.style.height = '100%';
                    img.style.objectFit = 'cover';

                    div.appendChild(img);
                    container.appendChild(div);
                }
                reader.readAsDataURL(file);
            });
        }
    }
    
    function updateDeleteButton() {
        const checkboxes = document.querySelectorAll('input[name="delete_images"]:checked');
        const deleteBtn = document.getElementById('deleteImagesBtn');
        if (checkboxes.length > 0) {
            deleteBtn.style.display = 'block';
            deleteBtn.textContent = `Delete ${checkboxes.length} Selected Image${checkboxes.length > 1 ? 's' : ''}`;
        } else {
            deleteBtn.style.display = 'none';
        }
    }
    
    // Confirm before deleting images
    document.getElementById('deleteImageForm')?.addEventListener('submit', function(e) {
        const checked = document.querySelectorAll('input[name="delete_images"]:checked').length;
        if (checked > 0) {
            if (!confirm(`Are you sure you want to delete ${checked} image${checked > 1 ? 's' : ''}? This action cannot be undone.`)) {
                e.preventDefault();
            }
        } else {
            e.preventDefault();
        }
    });
</script>
{% endblock %}

