{% extends 'base.html' %}

{% block content %}
<div style="max-width: 1200px; margin: 0 auto; padding: 2rem 0;">
    <!-- Profile Header -->
    <div class="card" style="padding: 2rem; margin-bottom: 2rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 1rem;">
        <div style="display: flex; align-items: center; gap: 2rem; flex-wrap: wrap;">
            <div style="width: 120px; height: 120px; border-radius: 50%; background: rgba(255,255,255,0.2); color: white; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 2.5rem; border: 4px solid white; box-shadow: 0 8px 24px rgba(0,0,0,0.2);">
                {{ profile_user.username|slice:":2"|upper }}
            </div>
            <div style="flex: 1;">
                <h1 style="font-size: 2rem; font-weight: 800; margin-bottom: 0.5rem; color: white;">
                    {{ profile_user.get_full_name|default:profile_user.username }}
                </h1>
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; flex-wrap: wrap;">
                    {% if profile_user.email %}
                    <p style="font-size: 1rem; opacity: 0.9; margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="opacity: 0.8;">
                            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                            <polyline points="22,6 12,13 2,6"></polyline>
                        </svg>
                        {{ profile_user.email }}
                    </p>
                    {% endif %}
                    {% if profile_user.profile.phone_number or profile_user.profile %}
                        {% if profile_user.profile.phone_number %}
                        <p style="font-size: 1rem; opacity: 0.9; margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="opacity: 0.8;">
                                <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                            </svg>
                            {{ profile_user.profile.phone_number }}
                        </p>
                        {% endif %}
                    {% endif %}
                </div>
                <p style="font-size: 0.9rem; opacity: 0.8; margin: 0;">Member since {{ profile_user.date_joined|date:"F Y" }}</p>
            </div>
            <div style="text-align: center; background: rgba(255,255,255,0.15); padding: 1rem 1.5rem; border-radius: 0.75rem; backdrop-filter: blur(10px);">
                <div style="font-size: 2rem; font-weight: 700; margin-bottom: 0.25rem;">{{ stats.average_rating }}</div>
                <div style="font-size: 0.875rem; opacity: 0.9;">‚≠ê Average Rating</div>
                <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 0.25rem;">({{ stats.total_ratings }} reviews)</div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
        <div class="card" style="padding: 1.5rem; text-align: center; border-left: 4px solid #3b82f6;">
            <div style="font-size: 2rem; font-weight: 700; color: #3b82f6; margin-bottom: 0.5rem;">{{ stats.total_listings }}</div>
            <div style="color: #64748b; font-size: 0.9rem;">Total Listings</div>
            <div style="color: #10b981; font-size: 0.8rem; margin-top: 0.25rem;">{{ stats.active_listings }} Active</div>
        </div>
        <div class="card" style="padding: 1.5rem; text-align: center; border-left: 4px solid #10b981;">
            <div style="font-size: 2rem; font-weight: 700; color: #10b981; margin-bottom: 0.5rem;">{{ stats.total_offers_made }}</div>
            <div style="color: #64748b; font-size: 0.9rem;">Offers Made</div>
            <div style="color: #3b82f6; font-size: 0.8rem; margin-top: 0.25rem;">{{ stats.accepted_offers }} Accepted</div>
        </div>
        <div class="card" style="padding: 1.5rem; text-align: center; border-left: 4px solid #f59e0b;">
            <div style="font-size: 2rem; font-weight: 700; color: #f59e0b; margin-bottom: 0.5rem;">{{ offers_received|length }}</div>
            <div style="color: #64748b; font-size: 0.9rem;">Offers Received</div>
        </div>
        <div class="card" style="padding: 1.5rem; text-align: center; border-left: 4px solid #8b5cf6;">
            <div style="font-size: 2rem; font-weight: 700; color: #8b5cf6; margin-bottom: 0.5rem;">{{ stats.total_ratings }}</div>
            <div style="color: #64748b; font-size: 0.9rem;">Total Ratings</div>
        </div>
    </div>

    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem;">
        <!-- Left Column: Listings -->
        <div>
            <div class="card" style="margin-bottom: 2rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid #e5e7eb;">
                    <h2 style="font-size: 1.5rem; font-weight: 700; color: #1e293b;">Listings</h2>
                    {% if is_own_profile %}
                    <a href="{% url 'my_listings' %}" style="color: #3b82f6; text-decoration: none; font-size: 0.9rem; font-weight: 600;">View All ({{ all_listings_count }})</a>
                    {% endif %}
                </div>
                
                {% if listings %}
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem;">
                    {% for listing in listings %}
                    <div class="card" style="padding: 0; overflow: hidden; border: 1px solid #e5e7eb; border-radius: 0.5rem; transition: transform 0.2s;">
                        <div style="height: 150px; background-color: #f3f4f6; position: relative; overflow: hidden;">
                            {% if listing.images.exists %}
                                {% with listing.images.first as first_image %}
                                <img src="{{ first_image.image.url }}" alt="{{ listing.title }}"
                                     style="width: 100%; height: 100%; object-fit: cover;">
                                {% endwith %}
                            {% else %}
                                <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #9ca3af;">No Image</div>
                            {% endif %}
                            <span style="position: absolute; top: 0.5rem; right: 0.5rem; background: rgba(0,0,0,0.7); color: white; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 600;">‚Çπ{{ listing.price }}</span>
                        </div>
                        <div style="padding: 0.75rem;">
                            <h3 style="font-size: 0.9rem; font-weight: 600; margin-bottom: 0.25rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                <a href="{% url 'listing_detail' listing.pk %}" style="color: #1e293b; text-decoration: none;">{{ listing.title }}</a>
                            </h3>
                            <p style="font-size: 0.75rem; color: #64748b; margin: 0;">
                                {% if listing.status == 'approved' %}<span style="color: #10b981;">‚úì Approved</span>
                                {% elif listing.status == 'pending' %}<span style="color: #f59e0b;">‚è≥ Pending</span>
                                {% else %}<span style="color: #ef4444;">‚úó Rejected</span>{% endif %}
                            </p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p style="color: #64748b; text-align: center; padding: 2rem;">No listings yet.</p>
                {% endif %}
            </div>

            <!-- Offers Made -->
            {% if offers_made %}
            <div class="card" style="margin-bottom: 2rem;">
                <h2 style="font-size: 1.5rem; font-weight: 700; color: #1e293b; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid #e5e7eb;">Offers Made</h2>
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    {% for offer in offers_made %}
                    <a href="{% url 'chat_with_user' offer.listing.seller.id offer.id %}" 
                       style="display: block; padding: 1rem; background-color: #f8fafc; border-radius: 0.5rem; border-left: 3px solid #3b82f6; text-decoration: none; transition: all 0.2s ease; cursor: pointer;"
                       onmouseover="this.style.backgroundColor='#f1f5f9'; this.style.transform='translateX(4px)';"
                       onmouseout="this.style.backgroundColor='#f8fafc'; this.style.transform='translateX(0)';">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                            <span style="font-weight: 600; color: #1e293b; font-size: 0.95rem;">{{ offer.listing.title }}</span>
                            <span style="font-weight: 700; color: #3b82f6; font-size: 1.1rem;">‚Çπ{{ offer.amount }}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem; color: #64748b;">
                            <span>
                                {% if offer.status == 'accepted' %}<span style="color: #10b981;">‚úì Accepted</span>
                                {% elif offer.status == 'rejected' %}<span style="color: #ef4444;">‚úó Rejected</span>
                                {% else %}<span style="color: #f59e0b;">‚è≥ Pending</span>{% endif %}
                            </span>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span>{{ offer.created_at|timesince }} ago</span>
                                <span style="color: #3b82f6; font-weight: 600; font-size: 0.75rem;">üí¨ Chat</span>
                            </div>
                        </div>
                    </a>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Right Column: Ratings & Activity -->
        <div>
            <!-- Ratings Received -->
            {% if ratings_received %}
            <div class="card" style="margin-bottom: 2rem;">
                <h2 style="font-size: 1.25rem; font-weight: 700; color: #1e293b; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid #e5e7eb;">Ratings Received</h2>
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    {% for rating in ratings_received %}
                    <div style="padding: 1rem; background-color: #f8fafc; border-radius: 0.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                            <div>
                                <div style="font-weight: 600; color: #1e293b; margin-bottom: 0.25rem;">{{ rating.rater.username }}</div>
                                <div style="font-size: 0.9rem; color: #f59e0b;">
                                    {% for i in "12345" %}
                                        {% if forloop.counter <= rating.score %}‚òÖ{% else %}‚òÜ{% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                            <span style="font-size: 0.8rem; color: #64748b;">{{ rating.created_at|timesince }} ago</span>
                        </div>
                        {% if rating.comment %}
                        <p style="font-size: 0.875rem; color: #475569; margin: 0.5rem 0 0 0; line-height: 1.4;">{{ rating.comment }}</p>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Offers Received -->
            {% if offers_received %}
            <div class="card">
                <h2 style="font-size: 1.25rem; font-weight: 700; color: #1e293b; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid #e5e7eb;">Offers Received</h2>
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    {% for offer in offers_received %}
                    <a href="{% url 'chat_with_user' offer.buyer.id offer.id %}" 
                       style="display: block; padding: 1rem; background-color: #f8fafc; border-radius: 0.5rem; border-left: 3px solid #10b981; text-decoration: none; transition: all 0.2s ease; cursor: pointer;"
                       onmouseover="this.style.backgroundColor='#f1f5f9'; this.style.transform='translateX(4px)';"
                       onmouseout="this.style.backgroundColor='#f8fafc'; this.style.transform='translateX(0)';">
                        <div style="font-weight: 600; color: #1e293b; margin-bottom: 0.5rem;">From: {{ offer.buyer.username }}</div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <span style="font-size: 0.9rem; color: #64748b;">{{ offer.listing.title|truncatewords:5 }}</span>
                            <span style="font-weight: 700; color: #10b981;">‚Çπ{{ offer.amount }}</span>
                        </div>
                        <div style="font-size: 0.8rem; color: #64748b; display: flex; align-items: center; gap: 0.5rem;">
                            {% if offer.status == 'accepted' %}<span style="color: #10b981;">‚úì Accepted</span>
                            {% elif offer.status == 'rejected' %}<span style="color: #ef4444;">‚úó Rejected</span>
                            {% else %}<span style="color: #f59e0b;">‚è≥ Pending</span>{% endif %}
                            <span>‚Ä¢</span>
                            <span>{{ offer.created_at|timesince }} ago</span>
                            <span style="margin-left: auto; color: #3b82f6; font-weight: 600; font-size: 0.75rem;">üí¨ Chat</span>
                        </div>
                    </a>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

